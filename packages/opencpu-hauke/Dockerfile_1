FROM opencpu/base:2.2.0

# Provide some R script files in the container
RUN mkdir -p /usr/opencpu/R
COPY ./R /usr/opencpu/R

# Copy configuration files
COPY ./opencpu-config/ /etc/opencpu/server.conf.d/
COPY ./files/.vimrc ~/

# Install development tools ----------------------------------------------------
# taken from https://github.com/opencpu/opencpu-server/blob/b3ad9ec2d94ca4142ffbc9c0aafaca0885a4caba/docker/rstudio/Dockerfile
# to enable rstudio for better customizastion of packages
RUN apt-get update && \
  apt-get install -y \
    rstudio-server r-base-dev sudo curl git libcurl4-openssl-dev libssl-dev \
    libxml2-dev libssh2-1-dev

# Workaround for rstudio apparmor bug
RUN echo "server-app-armor-enabled=0" >> /etc/rstudio/rserver.conf

# The following are top-level packages. It would be enough to install them
# as long as dependent packages are automatically installed.
#   r-cran-rstanarm=2.21.1-1cran1.2004.0
#   r-cran-units=0.6-7-1cran1.2004.0
#   r-cran-raster=3.4-5-1cran1.2004.0
#   r-cran-rcurl=1.98-1.2-1cran1.2004.0
#   r-cran-sf=0.9-7-1cran1.2004.0
#   r-cran-dplyr=1.0.3-1cran1.2004.0
#   r-cran-modelmetrics=1.2.2.2-1cran1.2004.0
#   r-cran-caret=6.0-86-1cran1.2004.0
#   r-cran-fs=1.5.0-1cran1.2004.0
#   r-cran-httr=1.4.2-1cran1.2004.0
#
# The names of the packages that fhpredict finally depends on (with all 
# recursive dependencies) were found (in R) with: 
#   remotes::install_github("KWB-R/fhpredict")
#   db <- installed.packages()
#   pd <- tools::package_dependencies("fhpredict", db = db, recursive = TRUE)
#   sort(pd[[1]])
#
# The version for each package was found (in /bin/bash) with:
#   apt-cache policy r-cran-<package>

RUN add-apt-repository ppa:c2d4u.team/c2d4u4.0+ && \
  apt-get update && \
  apt-get install -y \
   r-cran-askpass=1.1-1.1~ubuntu20.04.1~ppa1 \
   r-cran-assertthat=0.2.1-1.1~ubuntu20.04.1~ppa1 \
   r-cran-aws.signature=0.6.0-1cran1.2004.0 \
   r-cran-backports=1.2.1-1cran1.2004.0 \
   r-cran-base64enc=0.1-3-2.1.1.1~ubuntu20.04.1~ppa1 \
   r-cran-bayesplot=1.8.0-1cran1.2004.0 \
   r-cran-bitops=1.0-6-4.1~ubuntu20.04.1~ppa1 \
   r-cran-boot=1.3-25-2.2004.0 \
   r-cran-callr=3.5.1-1cran1.2004.0 \
   r-cran-caret=6.0-86-1cran1.2004.0 \
   r-cran-checkmate=2.0.0-1.1~ubuntu20.04.1~ppa1 \
   r-cran-class=7.3-17-1.2004.0 \
   r-cran-cli=2.2.0-1cran1.2004.0 \
   r-cran-clipr=0.7.1-1cran1.2004.0 \
   r-cran-codetools=0.2-18-1cran1.2004.0 \
   r-cran-colorspace=2.0-0-1cran1.2004.0 \
   r-cran-colourpicker=1.1.0-1cran1.2004.0 \
   r-cran-commonmark=1.7-1.1~ubuntu20.04.1~ppa1 \
   r-cran-crayon=1.3.4-4ubuntu1.1~ubuntu20.04.1~ppa1 \
   r-cran-crosstalk=1.1.1-1cran1.2004.0 \
   r-cran-curl=4.3+dfsg-1.1~ubuntu20.04.1~ppa1 \
   r-cran-data.table=1.13.6-1cran1.2004.0 \
   r-cran-desc=1.2.0-2.1~ubuntu20.04.1~ppa1 \
   r-cran-diffobj=0.3.3-1cran1.2004.0 \
   r-cran-digest=0.6.27-1cran1.2004.0 \
   r-cran-dplyr=1.0.3-1cran1.2004.0 \
   r-cran-dygraphs=1.1.1.6+dfsg-1.1~ubuntu20.04.1~ppa1 \
   r-cran-e1071=1.7-4-1cran1.2004.0 \
   r-cran-ellipsis=0.3.1-1cran1.2004.0 \
   r-cran-evaluate=0.14-1.1~ubuntu20.04.1~ppa1 \
   r-cran-fansi=0.4.2-1cran1.2004.0 \
   r-cran-farver=2.0.3-1cran1.2004.0 \
   r-cran-fastmap=1.0.1-2build1.1~ubuntu20.04.1~ppa1 \
   r-cran-foreach=1.5.1-1cran1.2004.0 \
   r-cran-fs=1.5.0-1cran1.2004.0 \
   r-cran-generics=0.1.0-1cran1.2004.0 \
   r-cran-ggplot2=3.3.3-1cran1.2004.0 \
   r-cran-ggridges=0.5.3-1cran1.2004.0 \
   r-cran-glue=1.4.2-1cran1.2004.0 \
   r-cran-gower=0.2.2-1cran1.2004.0 \
   r-cran-gtable=0.3.0+dfsg-1.1~ubuntu20.04.1~ppa1 \
   r-cran-gtools=3.8.2-1cran1.2004.0 \
   r-cran-hms=1.0.0-1cran1.2004.0 \
   r-cran-htmltools=0.5.1.1-1cran1.2004.0 \
   r-cran-htmlwidgets=1.5.3-1cran1.2004.0 \
   r-cran-httpuv=1.5.5-1cran1.2004.0 \
   r-cran-httr=1.4.2-1cran1.2004.0 \
   r-cran-igraph=1.2.6-1cran1.2004.0 \
   r-cran-inline=0.3.17-1cran1.2004.0 \
   r-cran-ipred=0.9-9-1.1~ubuntu20.04.1~ppa1 \
   r-cran-iterators=1.0.13-1cran1.2004.0 \
   r-cran-jsonlite=1.7.2-1cran1.2004.0 \
   r-cran-labeling=0.4.2-1cran1.2004.0 \
   r-cran-later=1.1.0.1-1cran1.2004.0 \
   r-cran-lattice=0.20-41-1cran1.2004.0 \
   r-cran-lava=1.6.8.1-1cran1.2004.0 \
   r-cran-lazyeval=0.2.2-1.1~ubuntu20.04.1~ppa1 \
   r-cran-lifecycle=0.2.0-1cran1.2004.0 \
   r-cran-lme4=1.1-26-1cran1.2004.0 \
   r-cran-lmtest=0.9.37-2.1~ubuntu20.04.1~ppa1 \
   r-cran-loo=2.4.1-1cran1.2004.0 \
   r-cran-lubridate=1.7.9.2-1cran1.2004.0 \
   r-cran-magrittr=2.0.1-1cran1.2004.0 \
   r-cran-markdown=1.1+dfsg-1.1~ubuntu20.04.1~ppa1 \
   r-cran-mgcv=1.8-33-1cran1.2004.0 \
   r-cran-mime=0.9-1.1~ubuntu20.04.1~ppa1 \
   r-cran-minqa=1.2.4-1cran2.2004.0 \
   r-cran-munsell=0.5.0-1.1~ubuntu20.04.1~ppa1 \
   r-cran-nlme=3.1.149-1cran2~ubuntu20.04.1~ppa1 \
   r-cran-nloptr=1.2.2.2-1cran1.2004.0 \
   r-cran-nnet=7.3-14-1.2004.0 \
   r-cran-openssl=1.4.3-1cran1.2004.0 \
   r-cran-packrat=0.5.0-2.1~ubuntu20.04.1~ppa1 \
   r-cran-pillar=1.4.7-1cran1.2004.0 \
   r-cran-pkgbuild=1.2.0-1cran1.2004.0 \
   r-cran-pkgconfig=2.0.3-1.1~ubuntu20.04.1~ppa1 \
   r-cran-pkgload=1.1.0-1cran1.2004.0 \
   r-cran-plyr=1.8.6-1cran1.2004.0 \
   r-cran-praise=1.0.0-3.1~ubuntu20.04.1~ppa1 \
   r-cran-prettyunits=1.1.1-1.1~ubuntu20.04.1~ppa1 \
   r-cran-processx=3.4.5-1cran1.2004.0 \
   r-cran-prodlim=2019.11.13-1.1~ubuntu20.04.1~ppa1 \
   r-cran-promises=1.1.1-1cran1.2004.0 \
   r-cran-ps=1.5.0-1cran1.2004.0 \
   r-cran-purrr=0.3.4-1cran1.2004.0 \
   r-cran-raster=3.4-5-1cran1.2004.0 \
   r-cran-rcurl=1.98-1.2-1cran1.2004.0 \
   r-cran-readr=1.4.0-1cran1.2004.0 \
   r-cran-recipes=0.1.15-1cran1.2004.0 \
   r-cran-reshape2=1.4.4-1cran1.2004.0 \
   r-cran-rlang=0.4.10-1cran1.2004.0 \
   r-cran-rpart=4.1-15-2.2004.0 \
   r-cran-rprojroot=2.0.2-1cran1.2004.0 \
   r-cran-rsconnect=0.8.16-1.1~ubuntu20.04.1~ppa1 \
   r-cran-rstan=2.21.2-1cran1.2004.0 \
   r-cran-rstanarm=2.21.1-1cran1.2004.0 \
   r-cran-rstantools=2.1.1-1cran1.2004.0 \
   r-cran-rstudioapi=0.13-1cran1.2004.0 \
   r-cran-scales=1.1.1-1cran1.2004.0 \
   r-cran-sf=0.9-7-1cran1.2004.0 \
   r-cran-shiny=1.5.0-1cran1.2004.0 \
   r-cran-shinyjs=2.0.0-1cran1.2004.0 \
   r-cran-shinystan=2.5.0-2.1~ubuntu20.04.1~ppa1 \
   r-cran-shinythemes=1.1.2+dfsg-1.1~ubuntu20.04.1~ppa1 \
   r-cran-sourcetools=0.1.7-2build1.1~ubuntu20.04.1~ppa1 \
   r-cran-sp=1:1.4-5-1cran1.2004.0 \
   r-cran-statmod=1.4.35-1cran1.2004.0 \
   r-cran-stringi=1.5.3-1cran1.2004.0 \
   r-cran-stringr=1.4.0-1.1~ubuntu20.04.1~ppa1 \
   r-cran-survival=3.2-7-1cran1.2004.0 \
   r-cran-sys=3.4-1cran1.2004.0 \
   r-cran-testthat=3.0.1-1cran1.2004.0 \
   r-cran-threejs=0.3.3+dfsg-1.1~ubuntu20.04.1~ppa1 \
   r-cran-tibble=3.0.5-1cran1.2004.0 \
   r-cran-tidyr=1.1.2-1cran1.2004.0 \
   r-cran-tidyselect=1.1.0-1cran1.2004.0 \
   r-cran-units=0.6-7-1cran1.2004.0 \
   r-cran-utf8=1.1.4-1cran1.2004.0 \
   r-cran-vctrs=0.3.6-1cran1.2004.0 \
   r-cran-withr=2.4.0-1cran1.2004.0 \
   r-cran-xfun=0.20-1cran1.2004.0 \
   r-cran-xml2=1.3.2-1cran1.2004.0 \
   r-cran-xtable=1:1.8-4-1.1~ubuntu20.04.1~ppa1 \
   r-cran-xts=0.12.1-1cran1.2004.0 \
   r-cran-yaml=2.2.1-1.1~ubuntu20.04.1~ppa1 \
   r-cran-zoo=1.8-8-1cran1.2004.0
   
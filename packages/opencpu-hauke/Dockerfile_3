FROM opencpu/base:2.2.0

RUN mv /etc/opencpu/server.conf /etc/opencpu/server.conf.bak

COPY ./server.conf /etc/opencpu/server.conf
COPY ./R .

ENV MAKEFLAGS="-j 2"
ENV MATRIX_EVAL="CC=gcc-7 && CXX=g++-7"
RUN mkdir -p ~/.R/ \
  && echo "CXX14 = g++-7 -fPIC -flto=2" >> ~/.R/Makevars \
  && echo "CXX14FLAGS = -mtune=native -march=native -Wno-unused-variable -Wno-unused-function -Wno###-unused-local-typedefs -Wno-ignored-attributes -Wno-deprecated-declarations -Wno-attributes -O3" >> ~/.R/Makevars

RUN add-apt-repository ppa:ubuntu-toolchain-r/test && apt-get update \
  && apt-get -y install libudunits2-dev libgdal-dev libspatialite-dev g++-7 libxml2 libxml2-dev libv8-dev  \
  && rm -rf /var/lib/apt/lists/*

RUN R -e "source(\"install_rstanarm.R\")"

EXPOSE 8004
EXPOSE 80
